<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>带货视频助手 - 授权管理</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        .device-info {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }
        .qr-code {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin: 20px 0;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn-danger {
            background-color: #e74c3c;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-success {
            background-color: #2ecc71;
        }
        .btn-success:hover {
            background-color: #27ae60;
        }
        .auth-section {
            background-color: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .note {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>带货视频助手 - 授权管理</h1>
    
    <div class="note">
        <p>本页面用于视频下载助手的设备授权管理。当设备下载次数达到10次上限后，需要通过此页面进行授权才能继续使用。</p>
    </div>

    <h2>设备信息</h2>
    <div class="device-info">
        <p><strong>设备ID:</strong> <span id="deviceId"></span></p>
        <p><strong>当前状态:</strong> <span id="authStatus" style="color: #e74c3c;">未授权</span></p>
        <p><strong>授权码:</strong> <span id="authCode"></span></p>
    </div>

    <h2>授权二维码</h2>
    <div class="qr-code">
        <p>请使用管理员账号扫描下方二维码进行授权</p>
        <div id="qrcode" style="display: inline-block; padding: 10px; background: white; border: 1px solid #ddd;">
            <!-- 二维码将在此处生成 -->
        </div>
    </div>

    <h2>管理员操作 - 生成授权码</h2>
    <div class="auth-section">
        <h3>生成授权码</h3>
        <p>请输入用户提供的设备ID，生成授权码：</p>
        <div>
            <input type="text" id="adminDeviceId" placeholder="输入用户设备ID" style="padding: 10px; font-size: 16px; width: 300px; margin-right: 10px;">
            <button class="btn btn-primary" onclick="generateAuthCodeForDevice()">生成授权码</button>
        </div>
        <div style="margin-top: 15px;">
            <p><strong>生成的授权码：</strong> <span id="generatedAuthCode" style="font-family: monospace; background: #f0f0f0; padding: 5px 10px; border-radius: 3px;"></span></p>
        </div>
    </div>

    <h2>用户操作 - 输入授权码</h2>
    <div class="auth-section">
        <h3>输入授权码</h3>
        <p>请输入管理员提供的授权码完成授权：</p>
        <div>
            <input type="text" id="userAuthCode" placeholder="输入授权码" style="padding: 10px; font-size: 16px; width: 300px; margin-right: 10px;">
            <button class="btn btn-success" onclick="verifyAuthCode()">验证授权码</button>
        </div>
    </div>

    <h2>使用说明</h2>
    <div>
        <h3>用户端流程</h3>
        <ol>
            <li>当您的设备下载次数达到10次上限后，会弹出授权提示</li>
            <li>复制提示窗口中的<strong>设备ID</strong>，发送给管理员</li>
            <li>等待管理员生成授权码并发送给您</li>
            <li>在授权提示窗口中输入管理员提供的<strong>授权码</strong></li>
            <li>点击"验证授权码"按钮完成授权</li>
            <li>授权成功后即可继续下载视频</li>
        </ol>
        
        <h3>管理员端流程</h3>
        <ol>
            <li>接收用户提供的<strong>设备ID</strong></li>
            <li>在本页面的"管理员操作 - 生成授权码"部分，输入用户的设备ID</li>
            <li>点击"生成授权码"按钮，系统会生成一个唯一的授权码</li>
            <li>将生成的<strong>授权码</strong>发送给用户</li>
            <li>用户输入授权码后，系统会自动验证并完成授权</li>
        </ol>
        
        <h3>网页授权流程（备选）</h3>
        <ol>
            <li>用户访问授权链接，进入本页面</li>
            <li>在"用户操作 - 输入授权码"部分，输入管理员提供的授权码</li>
            <li>点击"验证授权码"按钮完成授权</li>
        </ol>
    </div>

    <h2>授权记录</h2>
    <div id="authHistory" style="margin: 20px 0;">
        <p>暂无授权记录</p>
    </div>

    <script>
        // 生成随机授权码
        function generateAuthCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // 获取URL参数中的设备ID
        function getUrlParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const pairs = queryString.split('&');
            for (let i = 0; i < pairs.length; i++) {
                const pair = pairs[i].split('=');
                params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
            }
            return params;
        }

        // 初始化页面
        function init() {
            const params = getUrlParams();
            const deviceId = params.deviceId || '未知设备ID';
            const authCode = generateAuthCode();
            
            // 显示设备信息
            document.getElementById('deviceId').textContent = deviceId;
            document.getElementById('authCode').textContent = authCode;
            
            // 生成简单的二维码文本表示（实际项目中应使用二维码库）
            const qrContent = `DEVICE_ID: ${deviceId}\nAUTH_CODE: ${authCode}`;
            const qrElement = document.getElementById('qrcode');
            qrElement.innerHTML = `<pre style="font-family: monospace; font-size: 12px; line-height: 1;">${qrContent}</pre>`;
        }

        // 为指定设备生成授权码
        function generateAuthCodeForDevice() {
            const adminDeviceId = document.getElementById('adminDeviceId').value;
            
            if (!adminDeviceId) {
                alert('请输入设备ID');
                return;
            }
            
            // 生成基于设备ID的授权码（实际项目中应使用更复杂的算法）
            const timestamp = Date.now();
            const baseCode = adminDeviceId.substring(adminDeviceId.length - 6) + timestamp.toString().substring(8);
            const authCode = baseCode.toUpperCase();
            
            // 显示生成的授权码
            document.getElementById('generatedAuthCode').textContent = authCode;
            alert(`设备 ${adminDeviceId} 的授权码已生成：${authCode}\n请将此授权码发送给用户`);
        }

        // 用户验证授权码
        function verifyAuthCode() {
            const userAuthCode = document.getElementById('userAuthCode').value;
            const deviceId = document.getElementById('deviceId').textContent;
            
            if (!userAuthCode) {
                alert('请输入授权码');
                return;
            }
            
            // 实际项目中，这里应该发送请求到后端服务验证授权码
            // 这里只是模拟授权码验证（检查授权码是否基于设备ID生成）
            const expectedPrefix = deviceId.substring(deviceId.length - 6).toUpperCase();
            
            if (userAuthCode.startsWith(expectedPrefix)) {
                // 模拟授权成功
                setTimeout(() => {
                    alert(`授权码验证成功！设备 ${deviceId} 已授权。`);
                    document.getElementById('authStatus').textContent = '已授权';
                    document.getElementById('authStatus').style.color = '#2ecc71';
                    
                    // 保存授权状态到URL哈希，以便扩展读取
                    window.location.hash = `auth_success_${deviceId}_${userAuthCode}`;
                    
                    // 记录授权历史
                    const historyElement = document.getElementById('authHistory');
                    const now = new Date().toLocaleString();
                    historyElement.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="background-color: #f8f9fa;">
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">设备ID</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">授权时间</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">授权状态</th>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">${deviceId}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${now}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; color: #2ecc71;">已授权</td>
                            </tr>
                        </table>
                    `;
                }, 1000);
            } else {
                alert('授权码无效，请检查后重试');
            }
        }

        // 页面加载时初始化
        window.onload = init;
    </script>
</body>
</html>