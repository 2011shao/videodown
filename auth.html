<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>带货视频助手 - 授权管理</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn-danger {
            background-color: #e74c3c;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-success {
            background-color: #2ecc71;
        }
        .btn-success:hover {
            background-color: #27ae60;
        }
        .auth-section {
            background-color: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .note {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>带货视频助手 - 授权管理</h1>
    
    <div class="note">
        <p>本页面用于视频下载助手的设备授权管理。当设备下载次数达到10次上限后，需要通过此页面进行授权才能继续使用。</p>
    </div>

    <h2>管理员操作 - 生成授权码</h2>
    <div class="auth-section">
        <h3>生成授权码</h3>
        <p>请输入用户提供的设备ID，并选择授权到期日期：</p>
        <div style="margin: 15px 0;">
            <input type="text" id="adminDeviceId" placeholder="输入用户设备ID" style="padding: 10px; font-size: 16px; width: 300px; margin-right: 10px; border: 2px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin: 15px 0;">
            <label for="expiryDate" style="display: inline-block; width: 120px; text-align: right; margin-right: 10px;">授权到期日期：</label>
            <input type="date" id="expiryDate" style="padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 4px;">
            <span style="margin-left: 10px; font-size: 14px; color: #666;">默认30天后到期</span>
        </div>
        <div style="margin: 15px 0;">
            <button class="btn btn-primary" onclick="generateAuthCodeForDevice()">生成授权码</button>
        </div>
        <div style="margin-top: 15px;">
            <p><strong>生成的授权码：</strong> <span id="generatedAuthCode" style="font-family: monospace; background: #f0f0f0; padding: 5px 10px; border-radius: 3px;"></span></p>
        </div>
    </div>

    <h2>用户操作 - 输入授权码</h2>
    <div class="auth-section">
        <h3>输入授权码</h3>
        <p>请输入管理员提供的授权码完成授权：</p>
        <div>
            <input type="text" id="userAuthCode" placeholder="输入授权码" style="padding: 10px; font-size: 16px; width: 300px; margin-right: 10px; border: 2px solid #ddd; border-radius: 4px;">
            <button class="btn btn-success" onclick="verifyAuthCode()">验证授权码</button>
        </div>
    </div>

    <h2>使用说明</h2>
    <div>
        <h3>用户端流程</h3>
        <ol>
            <li>当您的设备下载次数达到10次上限后，会弹出授权提示</li>
            <li>复制提示窗口中的<strong>设备ID</strong>，发送给管理员</li>
            <li>等待管理员生成授权码并发送给您</li>
            <li>在授权提示窗口中输入管理员提供的<strong>授权码</strong></li>
            <li>点击"验证授权码"按钮完成授权</li>
            <li>授权成功后即可继续下载视频，<strong>每次授权有效期为30天</strong></li>
            <li>授权到期后，需要重新联系管理员获取授权码</li>
        </ol>
        
        <h3>管理员端流程</h3>
        <ol>
            <li>接收用户提供的<strong>设备ID</strong></li>
            <li>在本页面的"管理员操作 - 生成授权码"部分，输入用户的设备ID</li>
            <li>点击"生成授权码"按钮，系统会生成一个唯一的授权码</li>
            <li>将生成的<strong>授权码</strong>发送给用户</li>
            <li>用户输入授权码后，系统会自动验证并完成授权，<strong>授权有效期为30天</strong></li>
        </ol>
        

    </div>

    <h2>授权记录</h2>
    <div id="authHistory" style="margin: 20px 0;">
        <p>暂无授权记录</p>
    </div>

    <script>
        // 加密工具函数
        function encryptAuthCode(plainCode) {
            // 1. 添加前缀和后缀
            const prefixed = 'VID_AUTH_' + plainCode + '_END';
            
            // 2. 字符混淆：简单的字符替换
            const charMap = {
                'A': 'X', 'B': 'Y', 'C': 'Z', 'D': 'A', 'E': 'B',
                'F': 'C', 'G': 'D', 'H': 'E', 'I': 'F', 'J': 'G',
                'K': 'H', 'L': 'I', 'M': 'J', 'N': 'K', 'O': 'L',
                'P': 'M', 'Q': 'N', 'R': 'O', 'S': 'P', 'T': 'Q',
                'U': 'R', 'V': 'S', 'W': 'T', 'X': 'U', 'Y': 'V',
                'Z': 'W', '0': '5', '1': '6', '2': '7', '3': '8',
                '4': '9', '5': '0', '6': '1', '7': '2', '8': '3',
                '9': '4'
            };
            
            let obfuscated = '';
            for (let char of prefixed) {
                obfuscated += charMap[char] || char;
            }
            
            // 3. Base64编码
            const encoded = btoa(obfuscated);
            
            // 4. 再次进行字符替换，增加复杂度
            let final = '';
            for (let i = 0; i < encoded.length; i++) {
                const char = encoded.charAt(i);
                final += String.fromCharCode(char.charCodeAt(0) + 3);
            }
            
            return final;
        }

        // 解密授权码
        function decryptAuthCode(encryptedCode) {
            try {
                // 1. 逆向字符码偏移
                let shifted = '';
                for (let i = 0; i < encryptedCode.length; i++) {
                    const char = encryptedCode.charAt(i);
                    shifted += String.fromCharCode(char.charCodeAt(0) - 3);
                }
                
                // 2. Base64解码
                const decoded = atob(shifted);
                
                // 3. 逆向字符混淆
                const reverseCharMap = {
                    'X': 'A', 'Y': 'B', 'Z': 'C', 'A': 'D', 'B': 'E',
                    'C': 'F', 'D': 'G', 'E': 'H', 'F': 'I', 'G': 'J',
                    'H': 'K', 'I': 'L', 'J': 'M', 'K': 'N', 'L': 'O',
                    'M': 'P', 'N': 'Q', 'O': 'R', 'P': 'S', 'Q': 'T',
                    'R': 'U', 'S': 'V', 'T': 'W', 'U': 'X', 'V': 'Y',
                    'W': 'Z', '5': '0', '6': '1', '7': '2', '8': '3',
                    '9': '4', '0': '5', '1': '6', '2': '7', '3': '8',
                    '4': '9'
                };
                
                let deobfuscated = '';
                for (let char of decoded) {
                    deobfuscated += reverseCharMap[char] || char;
                }
                
                // 4. 移除前缀和后缀
                const plainCode = deobfuscated.replace('VID_AUTH_', '').replace('_END', '');
                
                return plainCode;
            } catch (error) {
                console.error('解密授权码失败:', error);
                return null;
            }
        }

        // 生成随机授权码
        function generateAuthCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // 获取URL参数中的设备ID
        function getUrlParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const pairs = queryString.split('&');
            for (let i = 0; i < pairs.length; i++) {
                const pair = pairs[i].split('=');
                params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
            }
            return params;
        }
        
        // 初始化页面
        function init() {
            const params = getUrlParams();
            const deviceId = params.deviceId || '';
            
            // 显示设备信息到管理员输入框
            document.getElementById('adminDeviceId').value = deviceId;
        }
        
        // 监听管理员设备ID输入变化（移除了对不存在元素的引用）
        document.addEventListener('DOMContentLoaded', function() {
            const adminDeviceIdInput = document.getElementById('adminDeviceId');
            if (adminDeviceIdInput) {
                adminDeviceIdInput.addEventListener('input', function() {
                    // 设备ID输入变化时的处理逻辑可以根据需要添加
                });
            }
        });

        // 初始化日期选择器，设置默认30天后的日期
        function initDatePicker() {
            const today = new Date();
            const defaultExpiry = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
            const formattedDate = defaultExpiry.toISOString().split('T')[0];
            document.getElementById('expiryDate').value = formattedDate;
        }

        // 为指定设备生成授权码
        function generateAuthCodeForDevice() {
            const adminDeviceId = document.getElementById('adminDeviceId').value;
            const expiryDateInput = document.getElementById('expiryDate');
            
            if (!adminDeviceId) {
                alert('请输入设备ID');
                return;
            }
            
            // 获取到期日期，默认为30天后
            const today = new Date();
            let expiryDate;
            
            if (expiryDateInput.value) {
                // 使用管理员选择的日期
                expiryDate = new Date(expiryDateInput.value);
                // 设置为当天的23:59:59
                expiryDate.setHours(23, 59, 59, 999);
            } else {
                // 默认30天后到期
                expiryDate = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
            }
            
            // 计算到期时间戳（转换为10位时间戳，精确到秒）
            const expiryTimestamp = Math.floor(expiryDate.getTime() / 1000);
            
            // 生成基于设备ID和到期时间的授权码
            const devicePrefix = adminDeviceId.substring(adminDeviceId.length - 6).toUpperCase();
            const timestamp = Date.now();
            const timeSuffix = timestamp.toString().substring(8);
            // 确保到期码是8位：如果时间戳小于10位，前面补0；否则取后8位
            let expiryCode = expiryTimestamp.toString();
            if (expiryCode.length < 8) {
                expiryCode = expiryCode.padStart(8, '0');
            } else {
                expiryCode = expiryCode.slice(-8); // 取后8位
            }
            
            // 生成原始授权码
            const plainAuthCode = devicePrefix + timeSuffix + expiryCode;
            
            // 加密授权码
            const authCode = encryptAuthCode(plainAuthCode);
            
            // 显示生成的授权码
            document.getElementById('generatedAuthCode').textContent = authCode;
            
            // 计算有效期天数
            const daysDiff = Math.ceil((expiryDate - today) / (24 * 60 * 60 * 1000));
            alert(`设备 ${adminDeviceId} 的授权码已生成：${authCode}\n授权有效期：${daysDiff}天\n到期日期：${expiryDate.toLocaleDateString()}\n请将此授权码发送给用户`);
        }

        // 用户验证授权码
        function verifyAuthCode() {
            const userAuthCode = document.getElementById('userAuthCode').value.trim();
            const deviceId = document.getElementById('adminDeviceId').value;
            
            if (!userAuthCode) {
                alert('请输入授权码');
                return;
            }
            
            if (!deviceId) {
                alert('请先输入设备ID');
                return;
            }
            
            // 实际项目中，这里应该发送请求到后端服务验证授权码
            // 这里解密授权码并验证是否基于设备ID生成
            const plainAuthCode = decryptAuthCode(userAuthCode);
            if (!plainAuthCode) {
                alert('授权码格式错误，请检查后重试');
                return;
            }
            
            const expectedPrefix = deviceId.substring(deviceId.length - 6).toUpperCase();
            console.log('解密后的授权码:', plainAuthCode);
            console.log('预期前缀:', expectedPrefix);
            console.log('实际前缀:', plainAuthCode.substring(0, 6));
            
            if (plainAuthCode.startsWith(expectedPrefix)) {
                // 模拟授权成功
                setTimeout(() => {
                    alert(`授权码验证成功！设备 ${deviceId} 已授权。`);
                    
                    // 保存授权状态到URL哈希，以便扩展读取
                    window.location.hash = `auth_success_${deviceId}_${userAuthCode}`;
                    
                    // 记录授权历史
                    const historyElement = document.getElementById('authHistory');
                    const now = new Date().toLocaleString();
                    historyElement.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="background-color: #f8f9fa;">
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">设备ID</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">授权时间</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">授权状态</th>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">${deviceId}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${now}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; color: #2ecc71;">已授权</td>
                            </tr>
                        </table>
                    `;
                }, 1000);
            } else {
                alert('授权码无效，请检查后重试');
            }
        }

        // 页面加载时初始化
        window.onload = function() {
            init();
            initDatePicker();
        };
    </script>
</body>
</html>